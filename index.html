<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Phim by Tống Trần Kiên</title>
        <link rel="icon" type="image/x-icon" href="favicon.ico" />
        <style>
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
                background: #000;
                font-family: Arial, sans-serif;
            }
            .video-container {
                position: relative;
                width: 100vw;
                height: 95vh;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            video, iframe {
                width: 98%;
                height: 95vh; /* Đặt chiều cao cố định */
                object-fit: contain;
                border: none;
            }
            .video-title {
                position: absolute;
                top: 15px;
                left: 105px;
                color: #fff;
                font-size: 18px;
                font-weight: 700;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
                max-width: 80%;
                word-wrap: break-word;
                z-index: 5;
            }
            .video-info {
                position: absolute;
                top: 15px;
                right: 105px;
                color: #fff;
                font-size: 16px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
                z-index: 5;
                text-align: left;
            }
            .actor, .time {
                display: flex;
                align-items: center;
                margin-bottom: 5px;
            }
            .actor::before, .time::before {
                content: "Coder: ";
                display: inline-block;
                width: 80px;
            }
            .time::before {
                content: "Time: ";
            }
            .episode-selector {
                position: absolute;
                top: 50px;
                left: 105px;
                z-index: 5;
            }
            .episode-selector select {
                background: rgba(0, 0, 0, 0.7);
                color: #fff;
                padding: 6px 10px;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
                border: none;
                outline: none;
            }
            .loading {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #fff;
                font-size: 24px;
                z-index: 10;
            }
        </style>
    </head>
    <body>
        <div class="video-container" id="videoContainer">
            <video id="videoPlayer" controls autoplay>
                <source src="" type="video/mp4" />
                Trình duyệt của bạn không hỗ trợ thẻ video.
            </video>
            <div class="video-title" id="videoTitle"></div>
            <div class="video-info" id="videoInfo">
                <div class="actor" id="coder"></div>
                <div class="time" id="time"></div>
            </div>
            <div class="episode-selector">
                <select id="episodeSelect" onchange="changeEpisode()">
                    <option value="">Chọn tập</option>
                </select>
            </div>
            <div class="loading" id="loading">Đang tải...</div>
        </div>
        <script>
            let videoList = [];
            let currentVideoIndex = 0;
            const videoPlayer = document.getElementById("videoPlayer");
            const videoTitle = document.getElementById("videoTitle");
            const loading = document.getElementById("loading");
            const episodeSelect = document.getElementById("episodeSelect");
            const videoContainer = document.getElementById("videoContainer");

            function parseCSV(csvText) {
                const lines = csvText.trim().split("\n");
                const headers = lines[0].split(",").map((h) => h.trim());
                const result = [];

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(",").map((c) => c.trim());
                    if (cols.length >= 3) {
                        result.push({
                            url: cols[headers.indexOf("url")],
                            title: cols[headers.indexOf("title")],
                            tap: cols[headers.indexOf("tap")],
                            coder: cols[headers.indexOf("coder")] || "Tống Trần Kiên",
                            time: cols[headers.indexOf("time")] || ".........................",
                        });
                    }
                }
                return result;
            }

            function saveVideoIndex(index) {
                localStorage.setItem("lastVideoIndex", index);
            }

            function getLastVideoIndex() {
                const saved = localStorage.getItem("lastVideoIndex");
                return saved !== null ? parseInt(saved) : 0;
            }

            function clearVideoContainer() {
                const existingIframe = document.getElementById("embedPlayer");
                if (existingIframe) existingIframe.remove();
                videoPlayer.style.display = "none";
                videoPlayer.pause();
            }

            function playVideo(index) {
                if (index >= 0 && index < videoList.length) {
                    const video = videoList[index];
                    clearVideoContainer();

                    videoTitle.textContent = video.title;
                    document.getElementById("coder").textContent = video.coder;
                    document.getElementById("time").textContent = video.time;
                    currentVideoIndex = index;
                    saveVideoIndex(index);
                    episodeSelect.value = index;

                    if (video.url.includes(".mp4")) {
                        videoPlayer.src = video.url;
                        videoPlayer.style.display = "block";
                        videoPlayer.currentTime = 0;
                        videoPlayer.play().catch((err) => {
                            console.error("Autoplay error:", err);
                            loading.textContent = "Nhấn để phát video.";
                        });
                    } else {
                        const iframe = document.createElement("iframe");
                        iframe.id = "embedPlayer";
                        iframe.src = video.url;
                        iframe.allowFullscreen = true;
                        iframe.style.width = "98%";
                        iframe.style.height = "95vh"; /* Đặt chiều cao cố định */
                        iframe.style.border = "none";
                        iframe.setAttribute("frameborder", "0");
                        videoContainer.appendChild(iframe);
                    }
                }
            }

            function changeEpisode() {
                const selectedIndex = parseInt(episodeSelect.value);
                if (!isNaN(selectedIndex)) playVideo(selectedIndex);
            }

            function populateEpisodeSelect() {
                episodeSelect.innerHTML = '<option value="">Chọn tập</option>';
                videoList.forEach((video, index) => {
                    const option = document.createElement("option");
                    option.value = index;
                    option.textContent = video.tap;
                    episodeSelect.appendChild(option);
                });
            }

            fetch("./data.csv")
                .then((response) => {
                    if (!response.ok) throw new Error("Không thể tải file CSV");
                    return response.text();
                })
                .then((data) => {
                    videoList = parseCSV(data);
                    loading.style.display = "none";
                    if (videoList.length > 0) {
                        populateEpisodeSelect();
                        const index = getLastVideoIndex();
                        playVideo(index < videoList.length ? index : 0);
                    } else {
                        loading.textContent = "Không tìm thấy video trong danh sách";
                    }
                })
                .catch((err) => {
                    console.error("Lỗi tải CSV:", err);
                    loading.textContent = "Lỗi tải danh sách video";
                });

            videoPlayer.addEventListener("ended", () => {
                videoPlayer.currentTime = 0;
                videoPlayer.play();
            });
        </script>
    </body>
</html>